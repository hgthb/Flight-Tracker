<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pleiku Smart Dashboard - B.23</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0a192f; color: #fff; padding: 10px; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        h2 { color: #64ffda; text-align: center; font-size: 1.2em; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .sub-title { text-align: center; color: #8892b0; font-size: 0.8em; margin-bottom: 15px; }
        
        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .tab-btn { flex: 1; padding: 10px; background: #112240; border: 1px solid #233554; color: #8892b0; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.9em; }
        .tab-btn.active { background: #64ffda; color: #0a192f; border-color: #64ffda; }

        /* DANH S√ÅCH */
        .flight-list { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .flight-card { background: #112240; padding: 12px; border-radius: 8px; border-left: 4px solid #8892b0; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; position: relative; }
        
        .card-dep { border-left-color: #f7d794; } /* V√†ng */
        .card-arr { border-left-color: #64ffda; } /* Xanh */
        
        .f-info { display: flex; flex-direction: column; gap: 2px; }
        .f-code { font-weight: bold; font-size: 1.1em; color: #fff; }
        .f-reg { font-size: 0.85em; color: #64ffda; font-weight: bold; }
        .f-route { color: #8892b0; font-size: 0.85em; }
        
        .f-meta { text-align: right; display: flex; flex-direction: column; gap: 2px; }
        .f-time { font-weight: bold; font-size: 1.1em; }
        .f-status { font-size: 0.8em; text-transform: uppercase; }
        
        .status-landed { color: #64ffda; }
        .status-active { color: #f7d794; }
        .status-scheduled { color: #8892b0; }

        .saved-badge { position: absolute; top: 5px; right: 5px; font-size: 0.6em; color: #8892b0; opacity: 0.5; }

        .loading { text-align: center; color: #8892b0; margin-top: 20px; font-style: italic; font-size: 0.9em; }
        .refresh-btn { position: fixed; bottom: 20px; right: 20px; background: #64ffda; color: #0a192f; border: none; width: 50px; height: 50px; border-radius: 50%; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

    <div class="container">
        <h2>‚úàÔ∏è PLEIKU DASHBOARD</h2>
        <div class="sub-title" id="lastUpdate">Ch·ªù c·∫≠p nh·∫≠t...</div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('all')">T·∫§T C·∫¢</button>
            <button class="tab-btn" onclick="switchTab('dep')">ƒêI (DEP)</button>
            <button class="tab-btn" onclick="switchTab('arr')">ƒê·∫æN (ARR)</button>
        </div>

        <div id="flightList" class="flight-list">
            <div class="loading">üì° ƒêang k·∫øt n·ªëi v·ªá tinh & ƒë·ªìng b·ªô d·ªØ li·ªáu...</div>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadAirportData()">‚Üª</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvQGy3_PTvNpFFrjpG99EDxv8MMnebJnc",
            authDomain: "pleiku-flight-radar.firebaseapp.com",
            databaseURL: "https://pleiku-flight-radar-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pleiku-flight-radar",
            storageBucket: "pleiku-flight-radar.firebasestorage.app",
            messagingSenderId: "539016276389",
            appId: "1:539016276389:web:cf6f4602237f6f91b0e04c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const airKey = "0bafa65a-71fb-4cd7-ada8-e8485b1b967f"; 
        const AIRPORT_CODE = "PXU"; 

        let allFlights = [];

        // H√ÄM X·ª¨ L√ù LOGIC B.21 CHO T·ª™NG CHUY·∫æN BAY
        async function processSingleFlight(f, type) {
            // Chu·∫©n b·ªã d·ªØ li·ªáu th√¥ t·ª´ API
            const dateStr = (type === 'dep' ? f.dep_time : f.arr_time).substring(0, 10);
            const customID = `${f.flight_iata}_${dateStr}`; // Key chu·∫©n: Flight_Date
            
            let apiReg = f.reg_number || f.hex || (f.aircraft ? f.aircraft.reg_number : null);
            let finalReg = "N/A";
            let isRecovered = false;

            try {
                // KI·ªÇM TRA FIREBASE (Logic B·∫£o To√†n D·ªØ Li·ªáu)
                const snapshot = await get(child(ref(db), `flight_logs/${customID}`));
                if (snapshot.exists()) {
                    const savedData = snapshot.val();
                    // N·∫øu API m·∫•t Reg m√† Database c√≥ -> D√πng Database
                    if ((!apiReg || apiReg === "N/A") && savedData.reg && savedData.reg !== "N/A") {
                        finalReg = savedData.reg;
                        isRecovered = true;
                    } else {
                        finalReg = apiReg || "N/A";
                    }
                } else {
                    finalReg = apiReg || "N/A";
                }
            } catch (e) {
                finalReg = apiReg || "N/A";
            }

            // D·ªØ li·ªáu chu·∫©n h√≥a ƒë·ªÉ hi·ªÉn th·ªã & L∆∞u
            const flightData = {
                flight: f.flight_iata,
                reg: finalReg,
                route: type === 'dep' ? `‚úàÔ∏è ƒê·∫øn ${f.arr_iata}` : `T·ª´ ${f.dep_iata} ‚úàÔ∏è`,
                raw_time: type === 'dep' ? f.dep_time : f.arr_time,
                display_time: (type === 'dep' ? (f.dep_actual || f.dep_time) : (f.arr_actual || f.arr_time)).substring(11, 16),
                status: (f.status || "SCHEDULED").toUpperCase(),
                type: type,
                is_recovered: isRecovered,
                search_date: dateStr,
                logged_at: new Date().toLocaleString("vi-VN")
            };

            // L∆ØU NG∆Ø·ª¢C L·∫†I V√ÄO FIREBASE (flight_logs)
            // Kh√¥ng c·∫ßn await ƒë·ªÉ t·ªëc ƒë·ªô hi·ªÉn th·ªã nhanh h∆°n
            set(ref(db, `flight_logs/${customID}`), flightData);

            return flightData;
        }

        window.loadAirportData = async function() {
            const listDiv = document.getElementById('flightList');
            listDiv.innerHTML = '<div class="loading">üì° ƒêang qu√©t to√†n b·ªô d·ªØ li·ªáu s√¢n bay...</div>';
            
            try {
                // 1. G·ªåI API API AIRLABS (L·ªãch tr√¨nh ƒêI v√† ƒê·∫æN)
                const depPromise = fetch(`https://airlabs.co/api/v9/schedules?dep_iata=${AIRPORT_CODE}&api_key=${airKey}`).then(r => r.json());
                const arrPromise = fetch(`https://airlabs.co/api/v9/schedules?arr_iata=${AIRPORT_CODE}&api_key=${airKey}`).then(r => r.json());

                const [depData, arrData] = await Promise.all([depPromise, arrPromise]);

                let rawFlights = [];
                if (depData.response) depData.response.forEach(f => rawFlights.push({f, type: 'dep'}));
                if (arrData.response) arrData.response.forEach(f => rawFlights.push({f, type: 'arr'}));

                // 2. X·ª¨ L√ù LOGIC B.21 CHO T·ª™NG CHUY·∫æN (Ch·∫°y song song)
                // ƒê√¢y l√† b∆∞·ªõc quan tr·ªçng: N√≥ s·∫Ω check Firebase cho t·ª´ng chuy·∫øn bay 1 l√∫c
                const processedPromises = rawFlights.map(item => processSingleFlight(item.f, item.type));
                allFlights = await Promise.all(processedPromises);

                // 3. S·∫ÆP X·∫æP THEO GI·ªú
                allFlights.sort((a, b) => new Date(a.raw_time) - new Date(b.raw_time));

                // 4. HI·ªÇN TH·ªä
                renderFlights('all');
                document.getElementById('lastUpdate').innerText = `C·∫≠p nh·∫≠t: ${new Date().toLocaleTimeString('vi-VN')}`;

            } catch (e) {
                console.error(e);
                listDiv.innerHTML = '<div class="loading">‚ùå L·ªói h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i.</div>';
            }
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderFlights(tab);
        }

        function renderFlights(filter) {
            const listDiv = document.getElementById('flightList');
            listDiv.innerHTML = "";

            const filtered = allFlights.filter(f => filter === 'all' || f.type === filter);

            if (filtered.length === 0) {
                listDiv.innerHTML = '<div class="loading">Kh√¥ng c√≥ chuy·∫øn bay n√†o.</div>';
                return;
            }

            filtered.forEach(f => {
                const isLanded = f.status === 'LANDED';
                const isActive = f.status === 'ACTIVE';
                
                let statusColor = 'status-scheduled';
                if (isLanded) statusColor = 'status-landed';
                if (isActive) statusColor = 'status-active';

                const cardClass = f.type === 'dep' ? 'card-dep' : 'card-arr';
                const regDisplay = f.reg !== "N/A" ? f.reg : "";
                const recoveredBadge = f.is_recovered ? '<span class="saved-badge">DB</span>' : '';

                listDiv.innerHTML += `
                    <div class="flight-card ${cardClass}">
                        ${recoveredBadge}
                        <div class="f-info">
                            <div class="f-code">${f.flight}</div>
                            <div class="f-reg">${regDisplay}</div>
                            <div class="f-route">${f.route}</div>
                        </div>
                        <div class="f-meta">
                            <div class="f-time ${f.type === 'dep' && isActive ? 'status-active' : ''}">${f.display_time}</div>
                            <div class="f-status ${statusColor}">${f.status}</div>
                        </div>
                    </div>
                `;
            });
        }

        loadAirportData();
    </script>
</body>
</html>
