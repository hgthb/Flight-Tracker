<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pleiku Flight Board - B.27</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0a192f; color: #fff; padding: 10px; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; padding-bottom: 80px; }
        h2 { color: #64ffda; text-align: center; font-size: 1.2em; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .sub-title { text-align: center; color: #8892b0; font-size: 0.8em; margin-bottom: 15px; }
        
        /* DATE PICKER BOX */
        .date-box { background: #112240; padding: 10px; border-radius: 8px; border: 1px solid #233554; display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .date-input { flex: 1; background: #0a192f; border: 1px solid #233554; color: #64ffda; padding: 8px; border-radius: 4px; font-family: inherit; font-size: 0.95em; outline: none; }
        .view-btn { background: #64ffda; color: #0a192f; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .view-btn:active { transform: scale(0.95); }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .tab-btn { flex: 1; padding: 10px; background: #112240; border: 1px solid #233554; color: #8892b0; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.9em; }
        .tab-btn.active { background: #64ffda; color: #0a192f; border-color: #64ffda; }

        /* DANH S√ÅCH CHI TI·∫æT */
        .flight-list { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .flight-card { background: #112240; padding: 12px; border-radius: 8px; border-left: 4px solid #8892b0; font-size: 0.9em; position: relative; display: flex; flex-direction: column; gap: 8px; }
        
        .card-dep { border-left-color: #f7d794; } 
        .card-arr { border-left-color: #64ffda; } 

        .row { display: flex; justify-content: space-between; align-items: center; }
        .f-code { font-weight: bold; font-size: 1.2em; color: #fff; }
        .f-status { font-size: 0.8em; text-transform: uppercase; font-weight: bold; }
        .f-route { color: #8892b0; font-size: 0.9em; flex: 1; } 
        
        .f-reg-box { text-align: right; font-size: 0.9em; }
        .reg-label { color: #8892b0; font-weight: normal; font-size: 0.9em; margin-right: 4px; }
        .f-reg { color: #64ffda; font-weight: bold; }
        
        .time-box { display: flex; gap: 15px; font-size: 0.9em; background: #0a192f; padding: 5px 8px; border-radius: 4px; width: 100%; justify-content: space-around; box-sizing: border-box; }
        .t-label { color: #8892b0; font-size: 0.8em; margin-right: 3px; }
        .t-val { font-weight: bold; color: #fff; }
        .t-val.actual { color: #f7d794; }

        .gate-info { font-size: 0.8em; color: #8892b0; display: flex; gap: 10px; justify-content: flex-end; }
        .gate-val { color: #fff; font-weight: bold; }

        .status-landed { color: #64ffda; }
        .status-active { color: #f7d794; }
        .status-scheduled { color: #8892b0; }

        .saved-badge { position: absolute; top: 5px; right: 5px; font-size: 0.6em; color: #8892b0; opacity: 0.5; }

        .loading { text-align: center; color: #8892b0; margin-top: 20px; font-style: italic; font-size: 0.9em; }
        .refresh-btn { position: fixed; bottom: 20px; right: 20px; background: #64ffda; color: #0a192f; border: none; width: 50px; height: 50px; border-radius: 50%; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

    <div class="container">
        <h2>‚úàÔ∏è PLEIKU FLIGHT BOARD <span style="font-size:0.6em; opacity:0.6; display:block; font-weight:normal">Version B.27</span></h2>
        <div class="sub-title" id="lastUpdate">Vui l√≤ng ch·ªçn ng√†y</div>

        <div class="date-box">
            <input type="date" id="selectedDate" class="date-input">
            <button class="view-btn" onclick="loadAirportData()">XEM L·ªäCH BAY</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('all')">T·∫§T C·∫¢</button>
            <button class="tab-btn" onclick="switchTab('dep')">ƒêI (DEP)</button>
            <button class="tab-btn" onclick="switchTab('arr')">ƒê·∫æN (ARR)</button>
        </div>

        <div id="flightList" class="flight-list">
            <div class="loading" style="margin-top:5px">üëá Ch·ªçn ng√†y v√† nh·∫•n n√∫t Xem</div>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadAirportData()">‚Üª</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvQGy3_PTvNpFFrjpG99EDxv8MMnebJnc",
            authDomain: "pleiku-flight-radar.firebaseapp.com",
            databaseURL: "https://pleiku-flight-radar-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pleiku-flight-radar",
            storageBucket: "pleiku-flight-radar.firebasestorage.app",
            messagingSenderId: "539016276389",
            appId: "1:539016276389:web:cf6f4602237f6f91b0e04c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const airKey = "0bafa65a-71fb-4cd7-ada8-e8485b1b967f"; 
        const AIRPORT_CODE = "PXU"; 

        let allFlights = [];

        // ƒê·∫∂T M·∫∂C ƒê·ªäNH NG√ÄY H√îM NAY
        document.getElementById('selectedDate').valueAsDate = new Date();

        async function processSingleFlight(f, type, selectedDateStr) {
            // L·∫•y ng√†y c·ªßa chuy·∫øn bay
            const flightDate = (type === 'dep' ? f.dep_time : f.arr_time).substring(0, 10);
            
            // CH·ªà X·ª¨ L√ù N·∫æU TR√ôNG KH·ªöP NG√ÄY ƒêANG CH·ªåN
            if (flightDate !== selectedDateStr) return null;

            const customID = `${f.flight_iata}_${flightDate}`;
            
            let apiReg = f.reg_number || f.hex || (f.aircraft ? f.aircraft.reg_number : null);
            let finalReg = "N/A";
            let isRecovered = false;

            try {
                const snapshot = await get(child(ref(db), `flight_logs/${customID}`));
                if (snapshot.exists()) {
                    const savedData = snapshot.val();
                    if ((!apiReg || apiReg === "N/A") && savedData.reg && savedData.reg !== "N/A") {
                        finalReg = savedData.reg;
                        isRecovered = true;
                    } else {
                        finalReg = apiReg || "N/A";
                    }
                } else {
                    finalReg = apiReg || "N/A";
                }
            } catch (e) { finalReg = apiReg || "N/A"; }

            // ƒê·ªïi ACTIVE th√†nh EN-ROUTE
            let status = (f.status || "SCHEDULED").toUpperCase();
            if (status === 'ACTIVE') status = 'EN-ROUTE';

            const depTime = f.dep_actual ? f.dep_actual.substring(11, 16) : f.dep_time.substring(11, 16);
            const isDepReal = !!f.dep_actual;
            const arrTime = f.arr_actual ? f.arr_actual.substring(11, 16) : f.arr_time.substring(11, 16);
            const isArrReal = !!f.arr_actual;

            const term = (type === 'dep' ? f.dep_terminal : f.arr_terminal) || null;
            const gate = (type === 'dep' ? f.dep_gate : f.arr_gate) || null;

            const flightData = {
                flight: f.flight_iata,
                reg: finalReg,
                route: type === 'dep' ? `PXU ‚ûî ${f.arr_iata}` : `${f.dep_iata} ‚ûî PXU`,
                dep_display: depTime,
                arr_display: arrTime,
                is_dep_real: isDepReal,
                is_arr_real: isArrReal,
                term: term,
                gate: gate,
                status: status,
                type: type,
                is_recovered: isRecovered,
                search_date: flightDate,
                raw_sort_time: type === 'dep' ? f.dep_time : f.arr_time,
                logged_at: new Date().toLocaleString("vi-VN")
            };

            set(ref(db, `flight_logs/${customID}`), flightData);
            return flightData;
        }

        window.loadAirportData = async function() {
            const listDiv = document.getElementById('flightList');
            const pickedDate = document.getElementById('selectedDate').value; // YYYY-MM-DD
            
            if (!pickedDate) return alert("Vui l√≤ng ch·ªçn ng√†y!");

            listDiv.innerHTML = `<div class="loading">üì° ƒêang t·∫£i l·ªãch bay ng√†y ${pickedDate}...</div>`;
            
            try {
                // G·ªçi API Schedules
                const depPromise = fetch(`https://airlabs.co/api/v9/schedules?dep_iata=${AIRPORT_CODE}&api_key=${airKey}`).then(r => r.json());
                const arrPromise = fetch(`https://airlabs.co/api/v9/schedules?arr_iata=${AIRPORT_CODE}&api_key=${airKey}`).then(r => r.json());

                const [depData, arrData] = await Promise.all([depPromise, arrPromise]);

                let rawFlights = [];
                if (depData.response) depData.response.forEach(f => rawFlights.push({f, type: 'dep'}));
                if (arrData.response) arrData.response.forEach(f => rawFlights.push({f, type: 'arr'}));

                // X·ª¨ L√ù V√Ä L·ªåC THEO NG√ÄY
                const processedPromises = rawFlights.map(item => processSingleFlight(item.f, item.type, pickedDate));
                // L·ªçc b·ªè c√°c k·∫øt qu·∫£ null (kh√°c ng√†y)
                const results = await Promise.all(processedPromises);
                allFlights = results.filter(item => item !== null);

                // S·∫ÆP X·∫æP
                allFlights.sort((a, b) => new Date(a.raw_sort_time) - new Date(b.raw_sort_time));

                renderFlights('all');
                document.getElementById('lastUpdate').innerText = `D·ªØ li·ªáu ng√†y: ${pickedDate} | C·∫≠p nh·∫≠t l√∫c: ${new Date().toLocaleTimeString('vi-VN')}`;

            } catch (e) {
                console.error(e);
                listDiv.innerHTML = '<div class="loading">‚ùå L·ªói k·∫øt n·ªëi ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu ng√†y n√†y.</div>';
            }
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderFlights(tab);
        }

        function renderFlights(filter) {
            const listDiv = document.getElementById('flightList');
            listDiv.innerHTML = "";

            const filtered = allFlights.filter(f => filter === 'all' || f.type === filter);

            if (filtered.length === 0) {
                listDiv.innerHTML = '<div class="loading">Kh√¥ng t√¨m th·∫•y chuy·∫øn bay n√†o trong ng√†y n√†y.</div>';
                return;
            }

            filtered.forEach(f => {
                const isLanded = f.status === 'LANDED';
                const isEnRoute = f.status === 'EN-ROUTE';
                
                let statusColor = 'status-scheduled';
                if (isLanded) statusColor = 'status-landed';
                if (isEnRoute) statusColor = 'status-active';

                const cardClass = f.type === 'dep' ? 'card-dep' : 'card-arr';
                const recoveredBadge = f.is_recovered ? '<span class="saved-badge">DB</span>' : '';

                let gateHtml = '';
                if (f.term || f.gate) {
                    gateHtml = `
                        <div class="gate-info">
                            ${f.term ? `<span>Term: <span class="gate-val">${f.term}</span></span>` : ''}
                            ${f.gate ? `<span>Gate: <span class="gate-val">${f.gate}</span></span>` : ''}
                        </div>`;
                }

                listDiv.innerHTML += `
                    <div class="flight-card ${cardClass}">
                        ${recoveredBadge}
                        <div class="row">
                            <div class="f-code">${f.flight || 'N/A'}</div>
                            <div class="f-status ${statusColor}">${f.status}</div>
                        </div>
                        <div class="row">
                            <div class="f-route">${f.route}</div>
                            <div class="f-reg-box">
                                <span class="reg-label">S·ªë ƒëƒÉng b·∫°:</span>
                                <span class="f-reg">${f.reg}</span>
                            </div>
                        </div>
                        <div class="time-box">
                            <div><span class="t-label">C·∫•t c√°nh:</span><span class="t-val ${f.is_dep_real ? 'actual' : ''}">${f.dep_display}</span></div>
                            <div><span class="t-label">H·∫° c√°nh:</span><span class="t-val ${f.is_arr_real ? 'actual' : ''}">${f.arr_display}</span></div>
                        </div>
                        ${gateHtml}
                    </div>
                `;
            });
        }
        
        // T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu h√¥m nay khi m·ªü web
        loadAirportData();
    </script>
</body>
</html>
